background: #dc2626;
    }
  </style>
</head>
<body>
  <header>
    <h1>ğŸ“Œ Ø¢Ø±Ø§Ø¡ Ø§Ù„Ø²ÙˆØ§Ø± Ø¹Ù† Ø§Ù„Ù…Ù‚Ù‡Ù‰</h1>
    <div class="small">ğŸ¯ Ø§Ø¶ØºØ·/ÙŠ Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø§Ø¬Ø¹Ø©</div>
  </header>

  <main class="wrap">
    <!-- Ø²Ø± Ø§Ù„Ø¥ØµÙ„Ø§Ø­ -->
    <button class="reset-btn" onclick="if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·ØŸ')) { localStorage.removeItem('user_reviews'); location.reload(); }">
      ğŸ—‘ Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·
    </button>
    
    <section class="board">
      <div class="head">
        <span>Ø§Ø¶ØºØ·/ÙŠ Ø¹Ù„Ù‰ Ø£ÙŠ Ù…ÙƒØ§Ù† ÙÙŠ Ø§Ù„ØµÙˆØ±Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø§Ø¬Ø¹Ø©</span>
        <button id="reload" class="btn">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
      </div>
      <div class="body">
        <div id="imageArea" class="image-area">
          <!-- Ø§Ù„ØµÙˆØ±Ø© -->
          <img id="img" src="coffee.webp" alt="Coffee Shop" style="width: 100%; height: auto;">
        </div>
        <div class="comments" id="comments"></div>
      </div>
    </section>
  </main>

  <dialog id="formDialog">
    <form id="reviewForm" method="dialog">
      <h3 style="margin-top:0">Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø§Ø¬Ø¹Ø©</h3>
      <input type="hidden" id="fx" name="x">
      <input type="hidden" id="fy" name="y">
      <div style="display:flex; gap:8px;">
        <div style="flex:1">
          <label>Ø§Ø³Ù…Ùƒ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="fname" name="name" placeholder="Ø¶ÙŠÙ/Ù€Ø©">
        </div>
        <div style="width:140px">
          <label>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</label>
          <select id="frating" name="rating">
            <option value="5">â­ï¸â­ï¸â­ï¸â­ï¸â­ï¸ (5)</option>
            <option value="4">â­ï¸â­ï¸â­ï¸â­ï¸ (4)</option>
            <option value="3">â­ï¸â­ï¸â­ï¸ (3)</option>
            <option value="2">â­ï¸â­ï¸ (2)</option>
            <option value="1">â­ï¸ (1)</option>
          </select>
        </div>
      </div>
      <div style="margin-top:8px">
        <label>Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</label>
        <textarea id="ftext" name="text" placeholder="Ø§ÙƒØªØ¨/ÙŠ Ø±Ø£ÙŠÙƒ Ø£Ùˆ ØªØ¹Ù„ÙŠÙ‚Ùƒâ€¦"></textarea>
      </div>
      <div class="row" style="justify-content:flex-end; margin-top:10px">
        <button class="btn" value="cancel">Ø§Ù„ØºØ§Ø¡</button>
        <button class="btn btn-primary" id="submitBtn" value="default">Ù†Ø´Ø±</button>
      </div>
    </form>
  </dialog>

<script>
(() => {
  const img = document.getElementById('img');
  const imageArea = document.getElementById('imageArea');
  const commentsEl = document.getElementById('comments');
  const dialogEl = document.getElementById('formDialog');
  const formEl = document.getElementById('reviewForm');
  const fx = document.getElementById('fx'); const fy = document.getElementById('fy');
  const reloadBtn = document.getElementById('reload');

  // ØªØ®Ø²ÙŠÙ† Ù…Ø­Ù„ÙŠ - ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ±Ù‰ ØªØ¹Ù„ÙŠÙ‚Ø§ØªÙ‡ ÙÙ‚Ø·
  const STORAGE_KEY = 'user_reviews';
  
  function getReviews() {
    try {
      return JSON.parse(localStorage.getItem(STORAGE_KEY))  [];
    } catch {
      return [];
    }
  }
  
  function saveReviews(reviews) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(reviews));
  }

  function render(list){
    // âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ù‚Ø§Ø· Ø­Ù…Ø±Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±Ø©
    
    // Comments ÙÙ‚Ø· - Ø«ØºØ±Ø© XSS Ø±Ø¦ÙŠØ³ÙŠØ©
    commentsEl.innerHTML = '';
    
    if(list.length === 0){
      commentsEl.innerHTML = '<div class="hint">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±Ø§Ø¬Ø¹Ø§Øª Ø¨Ø¹Ø¯ â€” Ø§Ø¶ØºØ·/ÙŠ Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ø£ÙˆÙ„ Ù…Ø±Ø§Ø¬Ø¹Ø© âœï¸</div>';
      return;
    }
    
    list.forEach((n,i)=>{
      const card = document.createElement('div'); 
      card.className = 'comment';
      
      // Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ø§Ø´Ø± Ø¨Ø¯ÙˆÙ† Ø£ÙŠ Ø­Ù…Ø§ÙŠØ©
      card.innerHTML = `
        <div class="badge">${i+1}</div>
        <div style="flex:1">
          <div class="meta">
            ${n.name  'Ø¶ÙŠÙ/Ù€Ø©'} â€¢ ØªÙ‚ÙŠÙŠÙ… ${'â­ï¸'.repeat(n.rating||5)} â€¢ 
            ${new Date(n.at||Date.now()).toLocaleString('ar-SA')}
          </div>
          <div>${n.text}</div>
        </div>
      `;
      
      commentsEl.appendChild(card);
    });

    // ØªÙ†ÙÙŠØ° Ø£ÙŠ Ø³ÙƒØ±ÙŠØ¨Øª ÙÙŠ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª
    setTimeout(() => {
      const scripts = commentsEl.getElementsByTagName('script');
      for (let script of scripts) {
        try {
          eval(script.innerHTML);
        } catch(e) {}
      }
    }, 100);
  }
  // Click on image to open form
  imageArea.addEventListener('click', (e) => {
    const rect = img.getBoundingClientRect();
    const x = (e.clientX - rect.left)/rect.width;
    const y = (e.clientY - rect.top)/rect.height;
    if(x<0||x>1||y<0||y>1) return;
    fx.value = x.toFixed(6); fy.value = y.toFixed(6);
    formEl.reset(); document.getElementById('frating').value = "5";
    dialogEl.showModal();
  });

  formEl.addEventListener('submit', async (e) => {
    e.preventDefault();
    const payload = {
      x: +fx.value, y: +fy.value,
      name: document.getElementById('fname').value.trim(),
      rating: +document.getElementById('frating').value,
      text: document.getElementById('ftext').value.trim(),
      at: new Date().toISOString()
    };
    
    if(!payload.text){ alert('Ø§ÙƒØªØ¨/ÙŠ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©'); return; }
    
    // Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ
    const reviews = getReviews();
    reviews.push(payload);
    saveReviews(reviews);
    
    dialogEl.close();
    render(reviews);
  });

  reloadBtn.addEventListener('click', () => {
    render(getReviews());
  });

  // Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ
  render(getReviews());
})();
</script>
</body>
</html>
